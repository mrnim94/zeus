<h1 align="center" style="border-bottom: none">
    <a href="https://nimtechnology.com/2023/07/02/zeus-retention-project/" target="_blank"><img alt="Longhorn" width="120px" src="https://nimtechnology.com/wp-content/uploads/2023/07/2185568.png"></a><br>Zeus Roations
</h1>

<p align="center">Auto Rotations AWS key on Kubernetes</p>


## Instroduction
Zeus is the platform to help you to rotate the AWS Access and Secret Key, which are saved in secret on EKS

<!-- status autogenerated section -->
| Status        |                                                                                                                                                                                                                                                                                                                          |
| ------------- |--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Stability     | [alpha]: Step 4: Recheck features and write Dockerfile,...                                                                                                                                                                                                                          |
| Distributions | [Nimtechnology]                                                                                                                                                                                                                                                                                                          |
| Issues        | ![Open issues](https://img.shields.io/github/issues-search/mrnim94/zeus?query=is%3Aissue%20is%3Aopen%20label%3Abug%20&label=open&color=orange&logo=github) ![Closed issues](https://img.shields.io/github/issues-search/mrnim94/zeus?query=is%3Aissue%20is%3Aopen%20label%3Aclosed%20&label=open&color=blue&logo=github) |

[alpha]: https://github.com/open-telemetry/opentelemetry-collector#alpha
[Nimtechnology]: https://nimtechnology.com/2023/07/02/zeus-retention-project/
<!-- end autogenerated section -->

## How to Use Zeus Protations.

**First Step:** Using [EKS IRSA Terraform Module](https://registry.terraform.io/modules/mrnim94/eks-irsa/aws/latest) to provide the permission for Zues access AWS.

```hcl
variable "aws_region" {
  description = "Please enter the region used to deploy this infrastructure"
  type        = string
  default = "us-west-2"  
}

variable "cluster_id" {
  description = "Enter full name of EKS Cluster"
  type        = string
  default = "<Full Name EKS Cluster>" 
}

#Load informations of your EKS cluster
data "aws_eks_cluster" "eks_k8s" {
  name = var.cluster_id
}


module "eks-irsa" {
  source  = "mrnim94/eks-irsa/aws"
  version = "0.0.4"

  aws_region = var.aws_region
  environment = "dev"
  business_divsion = "irsa-zeus-rotations"

  k8s_namespace = "kube-system"
  k8s_service_account = "zeus-rotations"
  json_policy = <<EOT
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "iam:CreateAccessKey",
        "iam:ListAccessKeys",
        "iam:DeleteAccessKey"
      ],
      "Resource": "*"
    }
  ]
}
EOT

  aws_iam_openid_connect_provider_arn = "arn:aws:iam::${element(split(":", "${data.aws_eks_cluster.eks_k8s.arn}"), 4)}:oidc-provider/${element(split("//", "${data.aws_eks_cluster.eks_k8s.identity[0].oidc[0].issuer}"), 1)}"
}

output "irsa_iam_role_arn" {
  description = "aws_iam_openid_connect_provider_arn"
  value = module.eks-irsa.irsa_iam_role_arn
}
```

**Second step:** Install Zeus via Helm chart with IRSA that is created in the previous step.

```python
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: zeus-rotations-mdaas-dev
  namespace: argocd
spec:
  destination:
    namespace: kube-system
    name: 'arn:aws:eks:us-west-2:043XXXXX1869:cluster/<Full Name EKS Cluster>'
  project: meta-structure
  source:
    repoURL: https://mrnim94.github.io/zeus
    targetRevision: "0.1.5"
    chart: zeus
    helm:
      values: |
        image:
          repository: "mrnim94/zeus-rotations"
          pullPolicy: IfNotPresent
          tag: "master"
        serviceAccount:
          annotations:
            eks.amazonaws.com/role-arn: "arn:aws:iam::043XXXXX1869:role/irsa-zeus-rotations-dev-irsa-iam-role"
        config:
          schedules:
            - name: change-key-aws
              cron: "*/1 * * * *"
              usernameOnAws: thang.tran
              namespaceOnK8s: default
              accessKeyOnK8s:
                name: secret-aws
                key: accesskey
              secretKeyOnK8s:
                name: secret-aws
                key: secretkey
              restartWorkloads:
                - kind: deployment
                  name: "argo-workflow-argo-workflows-server"
```

### Explain the schedule configuration.

| Key | Value | Type | Description |
| --- | --- | --- | --- |
| **schedules** |  | Object | Schedule configurations |
| - name | change-key-aws | String | Name of the schedule |
| - cron | */1 * * * * | Cron String | Cron schedule, runs every minute |
| - usernameOnAws | thang.tran | String | AWS username |
| - namespaceOnK8s | default | String | Kubernetes namespace |
| **accessKeyOnK8s** |  | Object | AWS Access Key configurations on K8s |
| - name | secret-aws | String | Name of the secret for AWS access key |
| - key | accesskey | String | Key for the AWS access key |
| **secretKeyOnK8s** |  | Object | AWS Secret Key configurations on K8s |
| - name | secret-aws | String | Name of the secret for AWS secret key |
| - key | secretkey | String | Key for the AWS secret key |
| **restartWorkloads** |  | Object | Workload configurations that need to be restarted |
| - kind | deployment | String | Kind of the workload (e.g., deployment) |
| - name | argo-workflow-argo-workflows-server | String | Name of the workload to be restarted |



## Publish Helm Chart

```
helm package ./helm-chart/zeus --destination ./helm-chart/
helm repo index . --url https://mrnim94.github.io/zeus
```
